<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MAMMOCARE — Early Detection & Guidance</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="brand-badge" aria-hidden="true">MC</div>
        <span class="brand-name">MAMMOCARE</span>
      </div>
      <div class="links" role="navigation" aria-label="Main">
        <button class="link-btn" data-target="home">Home</button>
        <button class="link-btn" data-target="detect">Detect</button>
        <button class="link-btn" data-target="learn">Learn</button>
        <button class="link-btn" data-target="contact">Contact</button>
      </div>
      <div style="display:flex; gap:10px">
        <a class="cta" href="http://localhost:8000/login">Login</a>
        <a class="btn soft" href="http://localhost:8000/signup">Signup</a>
        <a class="btn soft" href="http://localhost:8000/me">My Cases</a>
      </div>
    </div>
  </nav>

  <main class="page">
    <!-- Home -->
    <section id="home" class="section active">
      <div class="container">
        <div class="hero">
          <div class="card hero-left reveal">
            <h1 class="title big">Early detection, made clear.</h1>
            <p class="sub">
              Upload a mammogram to see AI‑assisted findings with confidence scores.
              This tool supports learning and screening workflows — not primary diagnosis.
            </p>
            <div class="hero-actions">
              <button class="btn primary" data-target="detect">Upload Mammogram</button>
              <a class="btn soft" href="http://localhost:8000/me">View My Cases</a>
            </div>
            <div class="pill-row">
              <button class="pill" data-open="education">Educational</button>
              <button class="pill" data-open="support">Screening Support</button>
              <button class="pill accent" data-open="privacy">Privacy First</button>
            </div>
          </div>
          <div class="card hero-right reveal">
            <img class="hero-img" src="https://images.pexels.com/photos/7089023/pexels-photo-7089023.jpeg?auto=compress&cs=tinysrgb&w=1600" alt="Modern mammography machine"/>
          </div>
        </div>

        <div class="card reveal">
          <h2 class="title">How it works</h2>
          <div class="how-steps">
            <article class="how-step">
              <div class="how-num"><span>1</span></div>
              <div class="how-body">
                <h3 class="how-title">Upload a mammogram</h3>
                <p class="how-text">Use JPG/PNG files. Analysis uses the full image content.</p>
              </div>
            </article>
            <article class="how-step">
              <div class="how-num"><span>2</span></div>
              <div class="how-body">
                <h3 class="how-title">AI highlights areas</h3>
                <p class="how-text">Boxes and confidence scores for common findings.</p>
              </div>
            </article>
            <article class="how-step">
              <div class="how-num"><span>3</span></div>
              <div class="how-body">
                <h3 class="how-title">Review & learn</h3>
                <p class="how-text">See classes and simple explanations. Consult clinicians for medical advice.</p>
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>

    <!-- Detect -->
    <section id="detect" class="section" aria-labelledby="detect-title">
      <div class="container">
        <div class="card">
          <div class="detect-header">
            <div>
              <h2 id="detect-title" class="title">Upload & Detect</h2>
              <p class="sub small">AI‑assisted highlighting for review. Not a diagnostic tool.</p>
            </div>
            <div class="detect-header-pills">
              <span class="pill">High‑resolution friendly</span>
              <span class="pill">Local & Secure</span>
            </div>
          </div>

          <div class="detect-grid">
            <aside class="panel left-panel">
              <div class="panel-section">
                <label class="label">Drag & drop or choose a file</label>
                <div id="dropzone" class="dropzone" tabindex="0" role="button" aria-label="Drop image here or click to select">
                  Drop image here or click to select
                </div>
              </div>
              <div class="panel-section">
                <label class="label" for="fileInput">File</label>
                <input class="input" type="file" id="fileInput" accept="image/*" aria-describedby="fileHelp"/>
                <small id="fileHelp" class="help">Supported: JPG, JPEG, PNG</small>
              </div>
              <div class="panel-section">
                <label class="label" for="conf">Confidence threshold</label>
                <input class="input" type="number" id="conf" value="0.15" step="0.01" min="0" max="1" aria-describedby="confHelp"/>
                <small id="confHelp" class="help">Lower shows more findings; higher is stricter.</small>
              </div>
              <div class="panel-actions">
                <button class="btn primary" id="runBtn">Run Detection</button>
                <button class="btn soft" id="clearBtn">Clear</button>
                <button class="btn soft" id="downloadBtn">Download annotated</button>
              </div>
              <div class="summary">
                <div class="circle">
                  <div class="circle-label">Findings</div>
                  <div class="circle-value" id="sumCount">0</div>
                </div>
                <div class="circle">
                  <div class="circle-label">Top class</div>
                  <div class="circle-value" id="sumTop">—</div>
                </div>
                <div class="circle">
                  <div class="circle-label">Max confidence</div>
                  <div class="circle-value" id="sumConf">0%</div>
                </div>
              </div>
              <div class="class-explain" id="classExplain">No findings. When NORM appears, it means normal.</div>
            </aside>

            <section class="panel right-panel">
              <div class="canvas-wrap">
                <div class="canvas-toolbar">
                  <span class="toolbar-title">Preview</span>
                  <span class="toolbar-tip">Tip: Use browser zoom to inspect fine details</span>
                </div>
                <div class="canvas-box">
                  <canvas id="canvas" aria-label="Detection result"></canvas>
                </div>
                <div class="status" id="log" aria-live="polite">Status: Waiting for upload…</div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>

    <!-- Learn -->
    <section id="learn" class="section">
      <div class="container">
        <div class="card">
          <h2 class="title">Classes & meanings</h2>
          <p class="sub">Short descriptions of common classes.</p>
          <div class="glossary">
            <article class="gloss-card"><div class="gloss-tag">ARCH</div><div class="gloss-title">Architectural distortion</div><div class="gloss-text">Tissue looks pulled/distorted.</div></article>
            <article class="gloss-card"><div class="gloss-tag">ASYM</div><div class="gloss-title">Asymmetry</div><div class="gloss-text">One area is denser/different.</div></article>
            <article class="gloss-card"><div class="gloss-tag">CALC</div><div class="gloss-title">Calcification</div><div class="gloss-text">Small calcium deposits.</div></article>
          </div>
        </div>
      </div>
    </section>

    <!-- Contact -->
    <section id="contact" class="section">
      <div class="container">
        <div class="card">
          <h2 class="title">Contact & Credits</h2>
          <p class="sub">Built for educational and screening support.</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div>© 2025 MAMMOCARE • Educational and screening support</div>
    <div class="notice">Disclaimer: Not for primary diagnosis. Always consult a qualified clinician.</div>
  </footer>

  <script>
    // Section navigation
    const sections = {
      home: document.getElementById('home'),
      detect: document.getElementById('detect'),
      learn: document.getElementById('learn'),
      contact: document.getElementById('contact')
    };
    function showSection(key){
      Object.values(sections).forEach(s=>s.classList.remove('active'));
      (sections[key] || sections.home).classList.add('active');
      window.scrollTo({top:0, behavior:'smooth'});
    }
    document.querySelectorAll('[data-target]').forEach(el=>{
      el.addEventListener('click', ()=> showSection(el.getAttribute('data-target')));
    });

    // Detect page logic
    const API_URL = "http://localhost:8000/predict"; // backend
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const confInput = document.getElementById('conf');
    const runBtn = document.getElementById('runBtn');
    const clearBtn = document.getElementById('clearBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const canvas = document.getElementById('canvas');
    const log = document.getElementById('log');
    const sumCount = document.getElementById('sumCount');
    const sumTop = document.getElementById('sumTop');
    const sumConf = document.getElementById('sumConf');
    const classExplainEl = document.getElementById('classExplain');

    let imageFile = null;
    let imgObj = null;
    let scaleX = 1, scaleY = 1;

    const CLASS_INFO = {
      CALC: "Calcification — small calcium deposits.",
      CIRC: "Well‑defined masses — often benign but need review.",
      SPIC: "Spiculated masses — suspicious and need evaluation.",
      MISC: "Ill‑defined masses — unclear borders; review needed.",
      ARCH: "Architectural distortion — tissue pattern pulled/distorted.",
      ASYM: "Asymmetry — one area is denser/different.",
      NORM: "Normal — no abnormal findings detected."
    };

    function summarize(preds){
      sumCount.textContent = preds.length.toString();
      if (!preds.length){
        sumTop.textContent = "—";
        sumConf.textContent = "0%";
        classExplainEl.textContent = "No findings. When NORM appears, it means normal.";
        return;
      }
      let maxP = preds[0];
      for (const p of preds) if ((p.confidence||0) > (maxP.confidence||0)) maxP = p;
      const topClass = (maxP.class || "unknown");
      sumTop.textContent = topClass;
      sumConf.textContent = (((maxP.confidence || 0) * 100).toFixed(1)) + "%";
      classExplainEl.textContent = CLASS_INFO[topClass?.toUpperCase()] || "Explanation not available for this class.";
    }

    function renderDetections(preds){
      if (!imgObj) return;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(imgObj,0,0,canvas.width,canvas.height);
      ctx.strokeStyle = '#e11d48';
      ctx.lineWidth = 2.5 * Math.max(1, Math.min(scaleX, scaleY));
      ctx.font = '16px Segoe UI';
      ctx.fillStyle = '#e11d48';
      preds.forEach(p=>{
        const bb = p.bbox || p.box || [];
        const x1 = bb[0] || 0, y1 = bb[1] || 0, x2 = bb[2] || 0, y2 = bb[3] || 0;
        const sx1 = x1 * scaleX, sy1 = y1 * scaleY;
        const sx2 = x2 * scaleX, sy2 = y2 * scaleY;
        ctx.strokeRect(sx1, sy1, sx2 - sx1, sy2 - sy1);
        ctx.fillText(`${p.class || 'unknown'} (${(((p.confidence||0)*100).toFixed(1))}%)`, sx1 + 6, sy1 + 20);
      });
    }

    function loadImageFile(f){
      if (!f || !f.type || !f.type.startsWith('image/')){
        log.textContent = "Error: Please select a JPG/PNG image."; return;
      }
      imageFile = f;
      imgObj = new Image();
      imgObj.onload = ()=>{
        const nw = imgObj.naturalWidth || imgObj.width || 0;
        const nh = imgObj.naturalHeight || imgObj.height || 0;
        const maxW = 1400, ratio = Math.min(1, maxW / (nw || maxW));
        canvas.width = Math.round((nw || maxW) * ratio);
        canvas.height = Math.round((nh || maxW) * ratio);
        scaleX = canvas.width / (nw || canvas.width);
        scaleY = canvas.height / (nh || canvas.height);
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(imgObj,0,0,canvas.width,canvas.height);
        log.textContent = "Status: Image loaded. Ready to detect.";
        summarize([]);
      };
      imgObj.onerror = ()=>{ log.textContent = "Error: Load failed."; };
      imgObj.src = URL.createObjectURL(f);
    }

    async function callBackend(file, conf){
      const formData = new FormData();
      formData.append('file', file);
      const url = API_URL + "?conf=" + encodeURIComponent(conf);
      const res = await fetch(url, {
        method:'POST',
        body:formData,
        credentials:'include' // send login cookie so cases link to your user
      });
      if (!res.ok){
        const text = await res.text();
        throw new Error("HTTP " + res.status + " " + res.statusText + ": " + text);
      }
      return res.json();
    }

    // UI events
    if (dropzone) {
      dropzone.addEventListener('click', ()=> fileInput.click());
      dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.classList.add('drag'); });
      dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('drag'));
      dropzone.addEventListener('drop', (e)=>{
        e.preventDefault();
        dropzone.classList.remove('drag');
        const f = e.dataTransfer.files[0];
        if (f) loadImageFile(f);
      });
    }
    if (fileInput) {
      fileInput.addEventListener('change', (e)=>{
        const f = e.target.files[0];
        if (f) loadImageFile(f);
      });
    }
    if (runBtn) {
      runBtn.addEventListener('click', async ()=>{
        if (!imageFile){ log.textContent = "Please select an image first."; return; }
        const conf = parseFloat(confInput.value || "0.15");
        log.textContent = "Detecting…";
        try{
          const data = await callBackend(imageFile, conf);
          const preds = data.predictions || [];
          summarize(preds);
          renderDetections(preds);
          log.textContent = "Done.";
        }catch(err){
          log.textContent = "Error: " + err.message;
        }
      });
    }
    if (clearBtn) {
      clearBtn.addEventListener('click', ()=>{
        if (!imgObj) return;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(imgObj,0,0,canvas.width,canvas.height);
        summarize([]);
        log.textContent = "Status: Cleared annotations.";
      });
    }
    if (downloadBtn) {
      downloadBtn.addEventListener('click', ()=>{
        if (!canvas.width || !canvas.height){ log.textContent = "Upload an image first."; return; }
        const link = document.createElement('a');
        link.download = 'mammogram-annotated.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      });
    }
  </script>
</body>
</html>
